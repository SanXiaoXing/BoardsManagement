---
// æœ€ç®€åŒ–çš„æµ‹è¯•é¡µé¢ï¼Œç”¨äºéªŒè¯ Serverless éƒ¨ç½²
export const prerender = false;

// åŸºæœ¬ç¯å¢ƒä¿¡æ¯
const timestamp = new Date().toISOString();
const environment = {
  NODE_ENV: process.env.NODE_ENV || 'development',
  VERCEL: process.env.VERCEL || 'false',
  VERCEL_ENV: process.env.VERCEL_ENV || 'local',
  VERCEL_REGION: process.env.VERCEL_REGION || 'local',
  isServerless: !!(process.env.VERCEL || process.env.AWS_LAMBDA_FUNCTION_NAME)
};

// æ£€æŸ¥ç¯å¢ƒå˜é‡
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || process.env.PUBLIC_SUPABASE_URL;
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY || process.env.PUBLIC_SUPABASE_ANON_KEY;
const hasSupabaseUrl = !!supabaseUrl;
const hasSupabaseKey = !!supabaseKey;

// è¯¦ç»†çš„ç¯å¢ƒå˜é‡è¯Šæ–­
const envDiagnostics = {
  supabaseUrl: {
    present: hasSupabaseUrl,
    source: supabaseUrl ? (import.meta.env.PUBLIC_SUPABASE_URL ? 'import.meta.env' : 'process.env') : 'none',
    preview: supabaseUrl ? supabaseUrl.substring(0, 30) + '...' : 'missing'
  },
  supabaseKey: {
    present: hasSupabaseKey,
    source: supabaseKey ? (import.meta.env.PUBLIC_SUPABASE_ANON_KEY ? 'import.meta.env' : 'process.env') : 'none',
    preview: supabaseKey ? supabaseKey.substring(0, 10) + '...' : 'missing'
  },
  allSupabaseVars: Object.keys(process.env).filter(key => key.includes('SUPABASE'))
};

// Supabase è¿æ¥æµ‹è¯•
let supabaseTestResult = { success: false, error: null as string | null };
if (hasSupabaseUrl && hasSupabaseKey) {
  try {
    const { getSupabase } = await import('../lib/supabase');
    const supabase = getSupabase();
    supabaseTestResult.success = true;
  } catch (error) {
    supabaseTestResult.error = error instanceof Error ? error.message : String(error);
  }
}
---

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>éƒ¨ç½²æµ‹è¯•é¡µé¢</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
        background: #1a1a1a;
        color: #fff;
      }
      .status {
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 8px;
        border: 1px solid #333;
      }
      .success { background: rgba(0, 255, 0, 0.1); border-color: #0f0; }
      .error { background: rgba(255, 0, 0, 0.1); border-color: #f00; }
      .info { background: rgba(0, 100, 255, 0.1); border-color: #06f; }
      
      .error-details {
        margin-top: 1rem;
        padding: 1rem;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border-left: 4px solid #f00;
      }

      .error-details h3 {
        margin-top: 0;
        color: #ff6b6b;
      }

      .error-details ol {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
      }

      .error-details li {
        margin: 0.25rem 0;
      }

      .error-details code {
        background-color: #2a2a2a;
        padding: 0.125rem 0.25rem;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
      }

      .error-details a {
        color: #06f;
        text-decoration: underline;
      }
      pre { background: #2a2a2a; padding: 1rem; border-radius: 4px; overflow-x: auto; }
    </style>
  </head>
  <body>
    <h1>ğŸ§ª Serverless éƒ¨ç½²æµ‹è¯•</h1>
    
    <div class="status success">
      <h2>âœ… åŸºæœ¬åŠŸèƒ½æ­£å¸¸</h2>
      <p>é¡µé¢æˆåŠŸæ¸²æŸ“ï¼ŒServerless å‡½æ•°è¿è¡Œæ­£å¸¸</p>
      <p><strong>æ—¶é—´æˆ³:</strong> {timestamp}</p>
    </div>

    <div class="status info">
      <h2>ğŸŒ ç¯å¢ƒä¿¡æ¯</h2>
      <pre>{JSON.stringify(environment, null, 2)}</pre>
    </div>

    <div class={`status ${hasSupabaseUrl && hasSupabaseKey ? 'success' : 'error'}`}>
    <h2>ğŸ”‘ ç¯å¢ƒå˜é‡æ£€æŸ¥</h2>
    <p><strong>Supabase URL:</strong> {hasSupabaseUrl ? 'âœ… å·²é…ç½®' : 'âŒ ç¼ºå¤±'}</p>
    <p><strong>Supabase Key:</strong> {hasSupabaseKey ? 'âœ… å·²é…ç½®' : 'âŒ ç¼ºå¤±'}</p>
    
    {!hasSupabaseUrl || !hasSupabaseKey ? (
      <div class="error-details">
        <h3>ğŸš¨ ç¯å¢ƒå˜é‡é…ç½®é—®é¢˜</h3>
        {environment.VERCEL !== 'false' ? (
          <div>
            <p><strong>Vercel éƒ¨ç½²ç¯å¢ƒæ£€æµ‹åˆ°</strong></p>
            <p>è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤é…ç½®ç¯å¢ƒå˜é‡ï¼š</p>
            <ol>
              <li>è®¿é—® <a href="https://vercel.com/dashboard" target="_blank">Vercel Dashboard</a></li>
              <li>é€‰æ‹©ä½ çš„é¡¹ç›®</li>
              <li>è¿›å…¥ Settings â†’ Environment Variables</li>
              <li>æ·»åŠ  PUBLIC_SUPABASE_URL å’Œ PUBLIC_SUPABASE_ANON_KEY</li>
              <li>ç¡®ä¿é€‰æ‹© Production, Preview, Development ç¯å¢ƒ</li>
              <li>é‡æ–°éƒ¨ç½²é¡¹ç›®</li>
            </ol>
            <p>ğŸ“– è¯¦ç»†æŒ‡å—è¯·æŸ¥çœ‹é¡¹ç›®æ ¹ç›®å½•çš„ <code>VERCEL_ENV_SETUP.md</code></p>
          </div>
        ) : (
          <div>
            <p><strong>æœ¬åœ°å¼€å‘ç¯å¢ƒ</strong></p>
            <p>è¯·æ£€æŸ¥é¡¹ç›®æ ¹ç›®å½•çš„ <code>.env</code> æ–‡ä»¶æ˜¯å¦åŒ…å«æ­£ç¡®çš„ç¯å¢ƒå˜é‡</p>
          </div>
        )}
      </div>
    ) : null}
  </div>

  <div class="status info">
    <h2>ğŸ” è¯¦ç»†è¯Šæ–­ä¿¡æ¯</h2>
    <pre>{JSON.stringify(envDiagnostics, null, 2)}</pre>
  </div>

  {supabaseTestResult.success ? (
    <div class="status success">
      <h2>âœ… Supabase è¿æ¥æµ‹è¯•</h2>
      <p>Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸï¼</p>
    </div>
  ) : supabaseTestResult.error ? (
    <div class="status error">
      <h2>âŒ Supabase è¿æ¥æµ‹è¯•å¤±è´¥</h2>
      <p><strong>é”™è¯¯ä¿¡æ¯:</strong> {supabaseTestResult.error}</p>
    </div>
  ) : null}

    <div class="status info">
      <h2>ğŸ“ æµ‹è¯•è¯´æ˜</h2>
      <p>å¦‚æœä½ èƒ½çœ‹åˆ°è¿™ä¸ªé¡µé¢ï¼Œè¯´æ˜ï¼š</p>
      <ul>
        <li>Vercel Serverless å‡½æ•°æ­£å¸¸å·¥ä½œ</li>
        <li>Astro SSR æ¸²æŸ“æ­£å¸¸</li>
        <li>åŸºæœ¬çš„ç¯å¢ƒå˜é‡è®¿é—®æ­£å¸¸</li>
      </ul>
      <p><a href="/" style="color: #06f;">è¿”å›ä¸»é¡µ</a></p>
    </div>
  </body>
</html>