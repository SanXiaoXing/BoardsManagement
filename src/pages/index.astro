---
import { getSupabase } from "../lib/supabase";
import { cache } from "../lib/cache";
import FilterBar from "../components/FilterBar";
import PaginationIsland from "../components/PaginationIsland";
import Footer from "../components/Footer";
import "../styles/global.css";
// 将首页标记为非预渲染（SSR），保证根据查询参数动态渲染
export const prerender = false;

// 在 Serverless 冷启动或环境变量缺失时，避免直接抛错导致 500
let supabase: ReturnType<typeof getSupabase> | null = null;
let supInitError: Error | null = null;
try {
  supabase = getSupabase();
} catch (e: any) {
  supInitError = e;
}

// 读取筛选参数：公司（vendor_id）与类型（category），以及分页页码
const vendorIdParam = Astro.url.searchParams.get('vendor_id');
const categoryParam = Astro.url.searchParams.get('category');
const pageParam = Astro.url.searchParams.get('page');
const vendorIdRaw = vendorIdParam ? Number(vendorIdParam) : undefined;
const vendorId = (typeof vendorIdRaw === 'number' && Number.isFinite(vendorIdRaw)) ? vendorIdRaw : undefined;
const category = categoryParam ? String(categoryParam) : '';
const page = pageParam ? Math.max(1, Number(pageParam)) : 1;
const pageSize = 10;

const fmtDate = (v: any) => {
  const d = v ? new Date(v) : null;
  return d && !isNaN(d.getTime()) ? d.toLocaleString() : '-';
};

// 获取所有公司列表（使用缓存）
let vendorList = cache.get<any[]>('vendors');
if (!vendorList && supabase) {
  try {
    const { data, error } = await supabase.from("vendors").select("id, name").order("name");
    if (error) {
      console.error("获取供应商列表失败:", error);
      vendorList = [];
    } else {
      vendorList = data || [];
      cache.set('vendors', vendorList, 10 * 60 * 1000); // 缓存10分钟
    }
  } catch (e) {
    console.error("获取供应商列表异常:", e);
    vendorList = [];
  }
} else if (!vendorList) {
  vendorList = [];
}

// 获取所有类别（使用缓存）
let categories = cache.get<string[]>('categories');
if (!categories && supabase) {
  try {
    const { data: categoryRows, error } = await supabase.from("boards").select("category");
    if (error) {
      console.error("获取类别列表失败:", error);
      categories = [];
    } else {
      categories = categoryRows
        ? [...new Set(categoryRows.map((item) => item.category))]
            .filter(Boolean)
            .sort()
        : [];
      cache.set('categories', categories, 10 * 60 * 1000); // 缓存10分钟
    }
  } catch (e) {
    console.error("获取类别列表异常:", e);
    categories = [];
  }
} else if (!categories) {
  categories = [];
}

// 构建基础查询条件
const baseFilter = {
  ...(vendorId !== undefined ? { vendor_id: vendorId } : {}),
  ...(category ? { category } : {})
};

// 执行查询，添加错误处理和超时控制
let boards: any[] = [];
let totalCount = 0;
let error: any = null;

if (supabase) {
  try {
    // 使用 Promise.allSettled 代替 Promise.all 以避免一个查询失败导致整体失败
    const [boardsResult, totalCountResult] = await Promise.allSettled([
      // 获取当前页数据 - 简化查询，只获取必要字段
      supabase
        .from("boards")
        .select(
          `id, model, category, board_website, created_at, updated_at, vendor_id, vendors!inner ( id, name, website ), drivers ( id, os, duplex_mode, version, driver_url )`
        )
        .match(baseFilter)
        .order("created_at", { ascending: false })
        .range((page - 1) * pageSize, page * pageSize - 1),
      
      // 获取总数 - 使用更高效的计数查询
      supabase
        .from('boards')
        .select('id', { count: 'exact', head: true })
        .match(baseFilter)
    ]);

    // 处理主查询结果
    if (boardsResult.status === 'fulfilled') {
      const { data, error: boardsError } = boardsResult.value;
      if (boardsError) {
        console.error("获取板卡数据失败:", boardsError);
        error = boardsError;
        boards = [];
      } else {
        boards = data || [];
      }
    } else {
      console.error("板卡查询被拒绝:", boardsResult.reason);
      error = boardsResult.reason;
      boards = [];
    }

    // 处理计数查询结果
    if (totalCountResult.status === 'fulfilled') {
      const { count, error: countError } = totalCountResult.value;
      if (countError) {
        console.error("获取总数失败:", countError);
        totalCount = 0;
      } else {
        totalCount = count || 0;
      }
    } else {
      console.error("计数查询被拒绝:", totalCountResult.reason);
      totalCount = 0;
    }
  } catch (e) {
    console.error("查询异常:", e);
    error = e;
    boards = [];
    totalCount = 0;
  }
} else {
  error = supInitError;
  boards = [];
  totalCount = 0;
}
---

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>板卡列表</title>
    <!-- 样式通过模块导入，避免生产环境下 /src 路径不可用的问题 -->
    <!-- 已移除 <link rel="stylesheet" href="/src/styles/global.css" /> -->
  </head>
  <body class="dracula">
    { supInitError && (
      <div class="text-danger" style="padding: 12px; background: rgba(255,0,0,0.08); border: 1px solid rgba(255,0,0,0.3); margin: 12px; border-radius: 8px;">
        系统暂时不可用：{supInitError.message}。请稍后重试或联系管理员。
      </div>
    ) }
    <div id="app">
      <header class="site-header">
        <div class="container flex">
          <h1 class="title">板卡管理</h1>
        </div>
      </header>

      <main class="container">
        <section class="mb-16">
          <FilterBar client:load vendorList={(vendorList || []) as any} categories={categories} initialVendorId={vendorId} initialCategory={category} />
        </section>

        {error && <p class="text-danger">加载失败：{error.message}</p>}

        {
          !boards || boards.length === 0 ? (
            <p>暂无数据，请前往 管理员入口 添加，或更换筛选条件。</p>
          ) : (
            <>
              <table>
                <thead>
                  <tr>
                    <th>公司</th>
                    <th>型号</th>
                    <th>类型</th>
                    <th>驱动</th>
                    <th>官网</th>
                    <th>创建时间</th>
                  </tr>
                </thead>
                <tbody>
                  {boards?.map((b: any) => (
                    <tr>
                      <td>
                        {b.vendors?.name ? (
                          b.vendors?.website ? (
                            <a
                              href={b.vendors.website}
                              target="_blank"
                              rel="noreferrer"
                            >
                              {b.vendors.name}
                            </a>
                          ) : (
                            b.vendors.name
                          )
                        ) : (
                          "-"
                        )}
                      </td>
                      <td>
                        {b.model}
                      </td>
                      <td>
                        {b.category || "-"}
                      </td>
                      <td>
                        {Array.isArray(b.drivers) && b.drivers.length > 0 ? (
                          <ul class="list-drivers">
                            {b.drivers.map((d: any) => (
                              <li>
                                <a href={d.driver_url} target="_blank" rel="noreferrer">
                                  {d.os}{d.version ? ` · ${d.version}` : ''}{d.duplex_mode ? ` · ${d.duplex_mode}` : ''}
                                </a>
                              </li>
                            ))}
                          </ul>
                        ) : (
                          "-"
                        )}
                      </td>
                      <td>
                        {b.board_website ? (
                          <a href={b.board_website} target="_blank" rel="noreferrer">
                            查看
                          </a>
                        ) : (
                          "-"
                        )}
                      </td>
                      <td>
                        {fmtDate(b.created_at)}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <section class="mt-16">
                <PaginationIsland client:only="react" current={page} total={totalCount || 0} pageSize={pageSize} />
              </section>
            </>
          )
        }
      </main>
      
      <Footer client:only="react" />
    </div>

    <div id="loading-overlay" hidden>
      <div class="spinner" aria-label="正在加载"></div>
    </div>

    <script>
      (function () {
        const app = document.getElementById('app');
        if (!app) return;
        // 进入动画
        app.classList.add('enter');
        setTimeout(() => app.classList.remove('enter'), 320);
      })();
    </script>
  </body>
</html>
