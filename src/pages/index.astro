---
import { getSupabase } from "../lib/supabase";
import { safeQuery, getEnvironmentTimeout } from "../lib/error-boundary";
import FilterBar from "../components/FilterBar";
import PaginationIsland from "../components/PaginationIsland";
import Footer from "../components/Footer";
import "../styles/global.css";

// 将首页标记为非预渲染（SSR），保证根据查询参数动态渲染
export const prerender = false;

// 安全的 Supabase 初始化
let supabase: ReturnType<typeof getSupabase> | null = null;
let supInitError: Error | null = null;

try {
  supabase = getSupabase();
} catch (e: any) {
  console.error("Supabase 初始化失败:", e);
  supInitError = e;
}

// 获取环境适配的超时时间
const queryTimeout = getEnvironmentTimeout();

// 读取筛选参数
const vendorIdParam = Astro.url.searchParams.get('vendor_id');
const categoryParam = Astro.url.searchParams.get('category');
const pageParam = Astro.url.searchParams.get('page');
const vendorIdRaw = vendorIdParam ? Number(vendorIdParam) : undefined;
const vendorId = (typeof vendorIdRaw === 'number' && Number.isFinite(vendorIdRaw)) ? vendorIdRaw : undefined;
const categoryIdRaw = categoryParam ? Number(categoryParam) : undefined;
const categoryId = (typeof categoryIdRaw === 'number' && Number.isFinite(categoryIdRaw)) ? categoryIdRaw : undefined;
const page = pageParam ? Math.max(1, Number(pageParam)) : 1;
const pageSize = 10;

const fmtDate = (v: any) => {
  const d = v ? new Date(v) : null;
  return d && !isNaN(d.getTime()) ? d.toLocaleString() : '-';
};

// 初始化数据
let vendorList: any[] = [];
let categories: Array<{ id: number; name: string }> = [];
let boards: any[] = [];
let totalCount = 0;
let error: any = null;

if (supabase && !supInitError) {
  // 1. 获取供应商列表（使用安全查询）
  const vendorResult = await safeQuery(
    () => supabase.from("vendors").select("id, name").order("name"),
    { timeout: queryTimeout, fallback: [] }
  );
  
  if (vendorResult.error) {
    console.error("获取供应商列表失败:", vendorResult.error.message);
  }
  vendorList = vendorResult.data || [];

  // 2. 获取类别列表（使用安全查询，来自 categories 表）
  const categoryResult = await safeQuery(
    () => supabase.from("categories").select("id, name").order("name"),
    { timeout: queryTimeout, fallback: [] }
  );
  
  if (categoryResult.error) {
    console.error("获取类别列表失败:", categoryResult.error.message);
  } else {
    categories = (categoryResult.data || []) as Array<{ id: number; name: string }>;
  }

  // 3. 构建查询条件
  const baseFilter = {
    ...(vendorId !== undefined ? { vendor_id: vendorId } : {}),
    ...(categoryId !== undefined ? { category_id: categoryId } : {})
  };

  // 4. 获取板卡数据（使用安全查询）
  const boardResult = await safeQuery(
    () => supabase
      .from("boards")
      .select(`
        id, model, board_website, created_at, updated_at, vendor_id, category_id,
        vendors:vendor_id ( id, name, website ),
        categories:category_id ( id, name ),
        drivers ( id, os, duplex_mode, version, driver_url )
      `)
      .match(baseFilter)
      .order("created_at", { ascending: false })
      .range((page - 1) * pageSize, page * pageSize - 1),
    { timeout: queryTimeout, fallback: [] }
  );
  
  if (boardResult.error) {
    console.error("获取板卡数据失败:", boardResult.error.message);
    error = boardResult.error;
  }
  boards = boardResult.data || [];

  // 5. 获取总数（使用安全查询）
  const countResult = await safeQuery(
    () => supabase
      .from('boards')
      .select('id', { count: 'exact', head: true })
      .match(baseFilter),
    { timeout: queryTimeout, fallback: { count: 0 } }
  );
  
  if (countResult.error) {
    console.error("获取总数失败:", countResult.error.message);
  } else {
    totalCount = countResult.data?.count || 0;
  }
} else {
  error = supInitError;
}
---

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>板卡列表</title>
  </head>
  <body class="dracula">
    { supInitError && (
      <div class="text-danger" style="padding: 12px; background: rgba(255,0,0,0.08); border: 1px solid rgba(255,0,0,0.3); margin: 12px; border-radius: 8px;">
        系统暂时不可用：{supInitError.message}。请稍后重试或联系管理员。
      </div>
    ) }
    
    <div id="app">
      <header class="site-header">
        <div class="container flex">
          <h1 class="title">板卡管理</h1>
        </div>
      </header>

      <main class="container">
        <section class="mb-16">
          <FilterBar 
            client:load 
            vendorList={vendorList} 
            categories={categories} 
            initialVendorId={vendorId} 
            initialCategory={categoryId} 
          />
        </section>

        {error && <p class="text-danger">加载失败：{error.message}</p>}

        {
          !boards || boards.length === 0 ? (
            <p>暂无数据，请前往 管理员入口 添加，或更换筛选条件。</p>
          ) : (
            <>
              <table>
                <thead>
                  <tr>
                    <th>公司</th>
                    <th>型号</th>
                    <th>类型</th>
                    <th>驱动</th>
                    <th>官网</th>
                    <th>创建时间</th>
                  </tr>
                </thead>
                <tbody>
                  {boards?.map((b: any) => (
                    <tr>
                      <td>
                        {b.vendors?.name ? (
                          b.vendors?.website ? (
                            <a
                              href={b.vendors.website}
                              target="_blank"
                              rel="noreferrer"
                            >
                              {b.vendors.name}
                            </a>
                          ) : (
                            b.vendors.name
                          )
                        ) : (
                          "-"
                        )}
                      </td>
                      <td>{b.model}</td>
                      <td>{(b.categories && b.categories.name) ? b.categories.name : "-"}</td>
                      <td>
                        {Array.isArray(b.drivers) && b.drivers.length > 0 ? (
                          <ul class="list-drivers">
                            {b.drivers.map((d: any) => (
                              <li>
                                <a href={d.driver_url} target="_blank" rel="noreferrer">
                                  {d.os}{d.version ? ` · ${d.version}` : ''}{d.duplex_mode ? ` · ${d.duplex_mode}` : ''}
                                </a>
                              </li>
                            ))}
                          </ul>
                        ) : (
                          "-"
                        )}
                      </td>
                      <td>
                        {b.board_website ? (
                          <a href={b.board_website} target="_blank" rel="noreferrer">
                            查看
                          </a>
                        ) : (
                          "-"
                        )}
                      </td>
                      <td>{fmtDate(b.created_at)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <section class="mt-16">
                <PaginationIsland 
                  client:only="react" 
                  current={page} 
                  total={totalCount || 0} 
                  pageSize={pageSize} 
                />
              </section>
            </>
          )
        }
      </main>
      
      <Footer client:only="react" />
    </div>

    <div id="loading-overlay" hidden>
      <div class="spinner" aria-label="正在加载"></div>
    </div>

    <script>
      (function () {
        const app = document.getElementById('app');
        if (!app) return;
        app.classList.add('enter');
        setTimeout(() => app.classList.remove('enter'), 320);
      })();
    </script>
  </body>
</html>
